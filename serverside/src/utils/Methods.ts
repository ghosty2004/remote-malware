import { Client, Message, TextChannel } from 'discord.js';
import jsZIP from 'jszip';
import { config } from 'dotenv';
config();

class Methods {
    private client?: Client;

    initClient(bot: Client) {
        this.client = bot;
    }

    eventParser(eventName: string, uniqueId: string, args: any[], type: "default" | "proc") {
        return JSON.stringify({ eventName, uniqueId, args, type });
    }

    getConfig(key: string) {
        return process.env[key];
    }

    sendSyntax(message: Message, command: string, ...params: string[]) {
        message.reply(`Syntax: \`${this.getConfig("BOT_PREFIX")}${command} ${params.map(m => `<${m}>`).join(" ")}\``);
    }

    sendError(message: Message, error: string) {
        message.reply(`Error: \`${error}\``);
    }

    sendLog(content: string) {
        if(typeof(this.client) === 'undefined') return;
        const channel = this.client.channels.cache.get(this.getConfig("BOT_LOG_CHANNEL_ID") as string) as TextChannel | undefined;
        if(typeof(channel) === 'undefined') return;
        channel.send(content);
    }

    firstLetterUppercase(str: string) {
        return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }

    createPlainTextAttachment(name: string, content: string) {
        return {
            name,
            contentType: 'text/plain',
            attachment: Buffer.from(content),
        }
    }

    async createZipAttachment(name: string, content: Array<{ fileName: string, fileData: Buffer }>) {
        const zip = new jsZIP();

        content.forEach(({ fileName, fileData }) => {
            zip.file(fileName, fileData);
        });

        return {
            name,
            contentType: 'application/zip',
            attachment: await zip.generateAsync({ type: 'nodebuffer' })
        }
    }

    sleep(ms: number) {
        return new Promise<void>(resolve => setTimeout(resolve, ms));
    }
};

export default new Methods();